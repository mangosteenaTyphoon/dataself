<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shanzhu.dataself.server.todo.mapper.TaskMapper">

    <resultMap type="com.shanzhu.dataself.api.todo.domain.Task" id="TaskResult">
        <id property="taskId" column="task_id"/>
        <result property="goalId" column="goal_id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="priority" column="priority"/>
        <result property="score" column="score"/>
        <result property="expectedStartTime" column="expected_start_time"/>
        <result property="expectedEndTime" column="expected_end_time"/>
        <result property="actualStartTime" column="actual_start_time"/>
        <result property="actualEndTime" column="actual_end_time"/>
        <result property="summary" column="summary"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <sql id="selectTaskVo">
        select task_id, goal_id, user_id, title, description, status, priority, score,
               expected_start_time, expected_end_time, actual_start_time, actual_end_time,
               summary, sort_order, create_by, create_time, update_by, update_time, remark
        from todo_task
    </sql>

    <select id="selectTaskList" parameterType="com.shanzhu.dataself.api.todo.domain.Task" resultMap="TaskResult">
        <include refid="selectTaskVo"/>
        where del_flag = '0'
        <if test="goalId != null">
            AND goal_id = #{goalId}
        </if>
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="title != null and title != ''">
            AND title like concat('%', #{title}, '%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="priority != null and priority != ''">
            AND priority = #{priority}
        </if>
        <if test="params.beginTime != null and params.beginTime != ''">
            AND date_format(create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
        </if>
        <if test="params.endTime != null and params.endTime != ''">
            AND date_format(create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
        </if>
        <!-- 数据范围过滤 -->
        ${params.dataScope}
        order by sort_order asc, create_time desc
    </select>

    <select id="selectTaskById" parameterType="Long" resultMap="TaskResult">
        <include refid="selectTaskVo"/>
        where task_id = #{taskId}
    </select>

    <select id="selectTasksByGoalId" parameterType="Long" resultMap="TaskResult">
        <include refid="selectTaskVo"/>
        where goal_id = #{goalId} and del_flag = '0'
        order by sort_order asc, create_time desc
    </select>

    <select id="countTasksByGoalId" parameterType="Long" resultType="int">
        select count(1) from todo_task
        where goal_id = #{goalId} and del_flag = '0'
    </select>

    <select id="countCompletedTasksByGoalId" parameterType="Long" resultType="int">
        select count(1) from todo_task
        where goal_id = #{goalId} and status = 'COMPLETED' and del_flag = '0'
    </select>

    <insert id="insertTask" parameterType="com.shanzhu.dataself.api.todo.domain.Task" useGeneratedKeys="true" keyProperty="taskId">
        insert into todo_task(
        <if test="goalId != null">goal_id,</if>
        <if test="userId != null">user_id,</if>
        <if test="title != null and title != ''">title,</if>
        <if test="description != null and description != ''">description,</if>
        <if test="status != null and status != ''">status,</if>
        <if test="priority != null and priority != ''">priority,</if>
        <if test="score != null and score != ''">score,</if>
        <if test="expectedStartTime != null">expected_start_time,</if>
        <if test="expectedEndTime != null">expected_end_time,</if>
        <if test="actualStartTime != null">actual_start_time,</if>
        <if test="actualEndTime != null">actual_end_time,</if>
        <if test="summary != null and summary != ''">summary,</if>
        <if test="sortOrder != null">sort_order,</if>
        <if test="createBy != null and createBy != ''">create_by,</if>
        <if test="remark != null and remark != ''">remark,</if>
        create_time
        )values(
        <if test="goalId != null">#{goalId},</if>
        <if test="userId != null">#{userId},</if>
        <if test="title != null and title != ''">#{title},</if>
        <if test="description != null and description != ''">#{description},</if>
        <if test="status != null and status != ''">#{status},</if>
        <if test="priority != null and priority != ''">#{priority},</if>
        <if test="score != null and score != ''">#{score},</if>
        <if test="expectedStartTime != null">#{expectedStartTime},</if>
        <if test="expectedEndTime != null">#{expectedEndTime},</if>
        <if test="actualStartTime != null">#{actualStartTime},</if>
        <if test="actualEndTime != null">#{actualEndTime},</if>
        <if test="summary != null and summary != ''">#{summary},</if>
        <if test="sortOrder != null">#{sortOrder},</if>
        <if test="createBy != null and createBy != ''">#{createBy},</if>
        <if test="remark != null and remark != ''">#{remark},</if>
        sysdate()
        )
    </insert>

    <update id="updateTask" parameterType="com.shanzhu.dataself.api.todo.domain.Task">
        update todo_task
        <set>
            <if test="title != null and title != ''">title = #{title},</if>
            <if test="description != null and description != ''">description = #{description},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="priority != null and priority != ''">priority = #{priority},</if>
            <if test="score != null and score != ''">score = #{score},</if>
            <if test="expectedStartTime != null">expected_start_time = #{expectedStartTime},</if>
            <if test="expectedEndTime != null">expected_end_time = #{expectedEndTime},</if>
            <if test="actualStartTime != null">actual_start_time = #{actualStartTime},</if>
            <if test="actualEndTime != null">actual_end_time = #{actualEndTime},</if>
            <if test="summary != null">summary = #{summary},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </set>
        where task_id = #{taskId}
    </update>

    <update id="updateTaskStatus">
        update todo_task set status = #{status}, update_time = sysdate()
        where task_id = #{taskId}
    </update>

    <delete id="deleteTaskByIds" parameterType="Long">
        update todo_task set del_flag = '2' where task_id in
        <foreach collection="array" item="taskId" open="(" separator="," close=")">
            #{taskId}
        </foreach>
    </delete>

    <select id="countTasksByUserId" parameterType="Long" resultType="int">
        select count(1) from todo_task
        where user_id = #{userId} and del_flag = '0'
    </select>

    <select id="countTasksByUserIdAndStatus" resultType="int">
        select count(1) from todo_task
        where user_id = #{userId} and status = #{status} and del_flag = '0'
    </select>

</mapper>
